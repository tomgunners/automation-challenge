name: QA Monorepo - Web | API | Performance

on:
  push:
    branches:
      - main

  pull_request:
    branches:
      - main

  schedule:
    - cron: '0 * * * *'   # â° a cada 1 hora

  workflow_dispatch:

env:
  NODE_VERSION: 20
  PNPM_VERSION: 9

jobs:
  qa-tests:
    name: AutomaÃ§Ã£o - ${{ matrix.package }}
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        include:
          - package: web
            path: web
            script: test

          - package: api
            path: api
            script: test

          - package: performance
            path: performance
            script: test

    steps:
      # ===============================
      # ğŸ“¥ Checkout
      # ===============================
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      # ===============================
      # ğŸŸ£ Setup PNPM
      # ===============================
      - name: ğŸŸ£ Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      # ===============================
      # ğŸŸ¢ Setup Node.js
      # ===============================
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      # ===============================
      # âš¡ Install k6 (only performance)
      # ===============================
      - name: âš¡ Install k6
        if: matrix.package == 'performance'
        run: |
          sudo apt-get update
          sudo apt-get install -y gnupg ca-certificates
          curl -fsSL https://dl.k6.io/key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/k6-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install -y k6

      # ===============================
      # ğŸ“¦ Install dependencies (workspace-aware)
      # ===============================
      - name: ğŸ“¦ Install dependencies
        run: |
          pnpm install --frozen-lockfile --filter ./${{ matrix.path }}...

      # ===============================
      # ğŸŒ Install Playwright Browsers (web & api)
      # ===============================
      - name: ğŸŒ Install Playwright Browsers
        if: matrix.package == 'web'
        run: |
          pnpm --filter ./${{ matrix.path }} exec playwright install --with-deps

      # ===============================
      # ğŸ§ª Run tests - WEB / API
      # ===============================
      - name: ğŸ§ª Run tests - ${{ matrix.package }}
        if: matrix.package != 'performance'
        env:
          ENV: ci
        run: |
          pnpm --filter ./${{ matrix.path }} run ${{ matrix.script }}

      # ===============================
      # ğŸ§ª Run tests - PERFORMANCE
      # ===============================
      - name: ğŸ§ª Run tests - performance
        if: matrix.package == 'performance'
        run: |
          pnpm --filter ./${{ matrix.path }} run ${{ matrix.script }}
        continue-on-error: true
      # ===============================
      # ğŸ“Š Upload Artifacts
      # ===============================
      - name: ğŸ“Š Upload Results - ${{ matrix.package }}
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-${{ matrix.package }}-${{ github.run_id }}
          path: |
            ${{ matrix.path }}/results/**
