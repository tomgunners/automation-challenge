name: QA Monorepo - API Only

on:
  push:
    branches:
      - main

  pull_request:
    branches:
      - main

  schedule:
    - cron: '0 * * * *'   # â° a cada 1 hora

  workflow_dispatch:

env:
  NODE_VERSION: 20
  PNPM_VERSION: 9
  ENV: ci

jobs:
  qa-api:
    name: AutomaÃ§Ã£o - API
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # ===============================
      # ğŸ“¥ Checkout
      # ===============================
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      # ===============================
      # ğŸŸ£ Setup PNPM
      # ===============================
      - name: ğŸŸ£ Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      # ===============================
      # ğŸŸ¢ Setup Node.js
      # ===============================
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      # ===============================
      # ğŸ“¦ Install dependencies (API only)
      # ===============================
      - name: ğŸ“¦ Install dependencies
        run: |
          pnpm install --frozen-lockfile --filter ./api...

      # ===============================
      # ğŸ§ª Run API tests
      # ===============================
      - name: ğŸ§ª Run API tests
        run: |
          pnpm --filter ./api run test

      # ===============================
      # ğŸ“Š Upload Artifacts
      # ===============================
      - name: ğŸ“Š Upload Results - API
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-api-${{ github.run_id }}
          path: |
            api/results/**
